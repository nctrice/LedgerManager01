(function(){
  function $(id){ return document.getElementById(id); }
  function on(el,evt,cb){ if(el) el.addEventListener(evt,cb); }
  function escCSV(v){ return '"'+String(v==null?'':v).replace(/"/g,'""')+'"'; }
  function setHidden(el, hide){ if(!el) return; if(hide){ if(el.classList && el.classList.add) el.classList.add('hidden'); else el.style.display='none'; } else { if(el.classList && el.classList.remove) el.classList.remove('hidden'); else el.style.display=''; } }
  function consoleError(e){ try{ var n=document.createElement('div'); n.style.cssText='position:fixed;bottom:8px;left:8px;right:8px;background:#7f1d1d;color:#fff;padding:8px 10px;border-radius:8px;z-index:9999;font:12px system-ui'; n.textContent='Error: '+(e&&e.message?e.message:String(e)); document.body.appendChild(n); setTimeout(function(){ if(n&&n.parentNode) n.parentNode.removeChild(n); }, 6000);}catch(_){} }

  function init(){
    try{ if('serviceWorker' in navigator){ window.addEventListener('load', function(){ try{ navigator.serviceWorker.register('./service-worker.js'); }catch(e){} }); } }catch(_){ }

    var tabButtons=document.querySelectorAll('.tab-btn'); var panels=document.querySelectorAll('.tab-panel');
    function showTab(name){ for(var i=0;i<tabButtons.length;i++){ var b=tabButtons[i]; var a=(b.getAttribute('data-tab')===name); if(a){ if(b.classList&&b.classList.add) b.classList.add('active'); } else { if(b.classList&&b.classList.remove) b.classList.remove('active'); } b.setAttribute('aria-selected', a?'true':'false'); } for(var j=0;j<panels.length;j++){ var p=panels[j]; var match=(p.id===name); if(match){ if(p.classList&&p.classList.add) p.classList.add('active'); } else { if(p.classList&&p.classList.remove) p.classList.remove('active'); } } }
    for(var t=0;t<tabButtons.length;t++){ (function(btn){ on(btn,'click', function(){ showTab(btn.getAttribute('data-tab')); }); })(tabButtons[t]); }
    try{ showTab('payments'); }catch(e){ consoleError(e); }

    var ledgerSelects={ payment:$('#payment-ledger'), paymentsFilter:$('#payments-filter-ledger'), recv:$('#recv-ledger'), recvFilter:$('#recv-filter-ledger'), stock:$('#stock-ledger'), dashboard:$('#dash-ledger') };

    function refreshLedgers(){ try{ var ledgers=(Store.getLedgers&&Store.getLedgers())||[]; for(var key in ledgerSelects){ if(!ledgerSelects.hasOwnProperty(key)) continue; var sel=ledgerSelects[key]; if(!sel) continue; var cur=sel.value; sel.innerHTML=''; if(sel===ledgerSelects.paymentsFilter || sel===ledgerSelects.recvFilter){ var optAll=document.createElement('option'); optAll.value='All'; optAll.textContent='All'; sel.appendChild(optAll); }
        for(var i=0;i<ledgers.length;i++){ var o=document.createElement('option'); o.value=ledgers[i]; o.textContent=ledgers[i]; sel.appendChild(o); }
        if(cur){ for(var ii=0; ii<sel.options.length; ii++){ if(sel.options[ii].value===cur){ sel.value=cur; break; } } }
      }
      var list=$('#ledger-list'); if(list){ list.innerHTML=''; for(var i2=0;i2<ledgers.length;i2++){ var s=document.createElement('span'); s.className='pill'; s.textContent=ledgers[i2]; list.appendChild(s);} }
    }catch(e){ consoleError(e); }
    }

    on($('#add-ledger-btn'),'click', function(){ try{ var input=$('#new-ledger-name'); var name=input?input.value:''; var res=Store.addLedger(name); if(!res.ok){ alert(res.msg); return;} if(input) input.value=''; refreshLedgers(); refreshDashboard(); refreshPaymentsTable(); refreshReceivables(); refreshStockTable(); }catch(e){ consoleError(e); }});

    refreshLedgers();

    var creditFields=$('#credit-fields'), debitFields=$('#debit-fields');
    var radios=document.querySelectorAll('input[name="pay-kind"]'); for(var r=0;r<radios.length;r++){ (function(radio){ on(radio,'change', function(){ if(!radio.checked) return; var v=radio.value; setHidden(creditFields, v!=='credit'); setHidden(debitFields, v!=='debit'); }); })(radios[r]); }

    on($('#add-credit-btn'),'click', function(){ try{ var sel=ledgerSelects.payment; var ledger=sel?sel.value:''; var dateEl=$('#payment-date'); var date=(dateEl && dateEl.value)?dateEl.value:new Date().toISOString().slice(0,10); var nameEl=$('#credit-name'); var name=nameEl?nameEl.value.trim():''; var ptEl=$('#credit-type'); var paymentType=ptEl?ptEl.value:''; var amtEl=$('#credit-amount'); var amount=Number(amtEl?amtEl.value:0); if(!ledger){ alert('Select a ledger'); return;} if(!amount){ alert('Enter amount'); return;} Store.addCredit({date:date,name:name,paymentType:paymentType,amount:amount,ledger:ledger}); if(nameEl) nameEl.value=''; if(amtEl) amtEl.value=''; refreshPaymentsTable(); refreshDashboard(); }catch(e){ consoleError(e); }});

    on($('#add-debit-btn'),'click', function(){ try{ var sel=ledgerSelects.payment; var ledger=sel?sel.value:''; var dateEl=$('#payment-date'); var date=(dateEl && dateEl.value)?dateEl.value:new Date().toISOString().slice(0,10); var itEl=$('#debit-invoice-type'); var invoiceType=itEl?itEl.value.trim():''; var inEl=$('#debit-invoice-number'); var invoiceNumber=inEl?inEl.value.trim():''; var amtEl=$('#debit-amount'); var amount=Number(amtEl?amtEl.value:0); if(!ledger){ alert('Select a ledger'); return;} if(!amount){ alert('Enter amount'); return;} Store.addDebit({date:date,invoiceType:invoiceType,invoiceNumber:invoiceNumber,amount:amount,ledger:ledger}); if(itEl) itEl.value=''; if(inEl) inEl.value=''; if(amtEl) amtEl.value=''; refreshPaymentsTable(); refreshDashboard(); }catch(e){ consoleError(e); }});

    var paymentsFilter=ledgerSelects.paymentsFilter; on(paymentsFilter,'change', refreshPaymentsTable);

    function refreshPaymentsTable(){ try{ var ledger=(paymentsFilter&&paymentsFilter.value)?paymentsFilter.value:'All'; var rows=Store.listPayments(ledger); var wrap=$('#payments-table'); if(!wrap) return; var html='<table><thead><tr><th>Date</th><th>Type</th><th>Details</th><th>Ledger</th><th>Amount</th><th></th></tr></thead><tbody>'; for(var i=0;i<rows.length;i++){ var r=rows[i]; var details=(r.type==='credit')?((r.name||'')+' · '+(r.paymentType||'')):((r.invoiceType||'')+' · #'+(r.invoiceNumber||'')); html+='<tr><td>'+(r.date||'')+'</td><td>'+r.type+'</td><td>'+details+'</td><td>'+r.ledger+'</td><td>'+naira(r.amount)+'</td><td><button class="danger" data-del="'+r.id+'" type="button">Delete</button></td></tr>'; } html+='</tbody></table>'; wrap.innerHTML=html; var delBtns=wrap.querySelectorAll('button[data-del]'); for(var d=0; d<delBtns.length; d++){ (function(btn){ on(btn,'click', function(){ try{ if(confirm('Delete entry?')){ Store.deletePayment(btn.getAttribute('data-del')); refreshPaymentsTable(); refreshDashboard(); } }catch(e){ consoleError(e); } }); })(delBtns[d]); }
      var totals=Store.paymentsTotals(ledger==='All'?null:ledger); var totalCredits=totals.credits||0, totalDebits=totals.debits||0; var bal=totalDebits-totalCredits; var elC=$('#payments-total-credits'), elD=$('#payments-total-debits'), elB=$('#payments-balance'); if(elC) elC.textContent=naira(totalCredits); if(elD) elD.textContent=naira(totalDebits); if(elB) elB.textContent=naira(bal); }catch(e){ consoleError(e); }
    }

    // Receivables
    var RECV_PAGE_SIZE=10; var recvPage=1;
    on($('#add-recv-btn'),'click', function(){ try{ var sel=ledgerSelects.recv; var ledger=sel?sel.value:''; var dateEl=$('#recv-date'); var date=(dateEl&&dateEl.value)?dateEl.value:new Date().toISOString().slice(0,10); var custEl=$('#recv-customer'); var customer=custEl?custEl.value.trim():''; var invEl=$('#recv-invnum'); var invoiceNumber=invEl?invEl.value.trim():''; var amtEl=$('#recv-amount'); var amount=Number(amtEl?amtEl.value:0); var comEl=$('#recv-comment'); var comment=comEl?comEl.value.trim():''; if(!ledger){ alert('Select a ledger'); return;} if(!customer){ alert('Enter customer'); return;} if(!amount){ alert('Enter amount'); return;} Store.addReceivable({date:date,customer:customer,invoiceNumber:invoiceNumber,amount:amount,comment:comment,ledger:ledger}); if(custEl) custEl.value=''; if(invEl) invEl.value=''; if(amtEl) amtEl.value=''; if(comEl) comEl.value=''; refreshReceivables(); refreshDashboard(); }catch(e){ consoleError(e); }});

    on(ledgerSelects.recvFilter,'change', function(){ recvPage=1; refreshReceivables(); });

    function refreshReceivables(){ try{ var sel=ledgerSelects.recvFilter; var ledger=(sel&&sel.value)?sel.value:'All'; var fullRows=Store.listReceivables(ledger); var wrap=$('#receivables-table'); if(!wrap) return; var totalAmt=0; for(var i=0;i<fullRows.length;i++){ totalAmt+=Number(fullRows[i].amount||0); } var totalEl=$('#receivables-total'); if(totalEl) totalEl.textContent='Total: '+naira(totalAmt); var totalPages=Math.max(1, Math.ceil(fullRows.length/RECV_PAGE_SIZE)); if(recvPage>totalPages) recvPage=totalPages; var start=(recvPage-1)*RECV_PAGE_SIZE; var rows=fullRows.slice(start,start+RECV_PAGE_SIZE); var html='<table><thead><tr><th>Date</th><th>Customer</th><th>Invoice #</th><th>Ledger</th><th>Amount</th><th>Comment</th><th></th><th></th></tr></thead><tbody>'; for(var j=0;j<rows.length;j++){ var r=rows[j]; html+='<tr><td>'+(r.date||'')+'</td><td>'+(r.customer||'')+'</td><td>'+(r.invoiceNumber||'')+'</td><td>'+r.ledger+'</td><td>'+naira(r.amount)+'</td><td>'+(r.comment||'')+'</td><td><button class="outline" data-edit="'+r.id+'" type="button">Edit</button></td><td><button class="danger" data-del="'+r.id+'" type="button">Delete</button></td></tr>'; } html+='</tbody></table>'; wrap.innerHTML=html; var delBtns=wrap.querySelectorAll('button[data-del]'); for(var d=0; d<delBtns.length; d++){ (function(btn){ on(btn,'click', function(){ try{ if(confirm('Delete receivable?')){ Store.deleteReceivable(btn.getAttribute('data-del')); refreshReceivables(); refreshDashboard(); } }catch(e){ consoleError(e); } }); })(delBtns[d]); }
      var editBtns=wrap.querySelectorAll('button[data-edit]'); for(var e=0; e<editBtns.length; e++){ (function(btn){ on(btn,'click', function(){ try{ openEditModal(btn.getAttribute('data-edit')); }catch(ex){ consoleError(ex); } }); })(editBtns[e]); }
      var prev=$('#recv-prev'), next=$('#recv-next'), info=$('#recv-page-info'); if(prev&&next&&info){ info.textContent='Page '+recvPage+'/'+totalPages; prev.disabled=(recvPage<=1); next.disabled=(recvPage>=totalPages); prev.onclick=function(){ if(recvPage>1){ recvPage--; refreshReceivables(); } }; next.onclick=function(){ if(recvPage<totalPages){ recvPage++; refreshReceivables(); } }; }
      refreshFavouriteSections(); }catch(e){ consoleError(e); }
    }

    function renderFavourites(){ try{ var favWrap=$('#fav-customers'); if(!favWrap) return; favWrap.innerHTML=''; var favs=Store.getFavourites(); for(var i=0;i<favs.length;i++){ (function(name){ var span=document.createElement('span'); span.className='pill'; span.textContent=name+' '; var btn=document.createElement('button'); btn.className='danger'; btn.textContent='×'; btn.type='button'; btn.style.marginLeft='.5rem'; on(btn,'click', function(){ try{ Store.removeFavourite(name); renderFavourites(); refreshFavouriteSections(); }catch(e){ consoleError(e); } }); span.appendChild(btn); favWrap.appendChild(span); })(favs[i]); } }catch(e){ consoleError(e); }
    }
    on($('#add-fav-btn'),'click', function(){ try{ var inp=$('#new-fav-name'); var name=inp?inp.value:''; var res=Store.addFavourite(name); if(!res.ok){ alert(res.msg); return;} if(inp) inp.value=''; renderFavourites(); refreshFavouriteSections(); }catch(e){ consoleError(e); }});

    function refreshFavouriteSections(){ try{ var FAV_PAGE_SIZE=10; window.__favPages=window.__favPages||{}; var favs=Store.getFavourites(); var box=$('#fav-recv-container'); if(!box) return; box.innerHTML=''; if(favs.length===0){ box.innerHTML='<p class="small">No favourites yet. Add up to 5 customers to track their receivables separately.</p>'; return; } var all=Store.listReceivables('All'); for(var i=0;i<favs.length;i++){ (function(name){ if(!(name in window.__favPages)) window.__favPages[name]=1; var allRows=[]; for(var a=0;a<all.length;a++){ if(all[a].customer===name) allRows.push(all[a]); } var totalPages=Math.max(1, Math.ceil(allRows.length/FAV_PAGE_SIZE)); if(window.__favPages[name]>totalPages) window.__favPages[name]=totalPages; var start=(window.__favPages[name]-1)*FAV_PAGE_SIZE; var rows=allRows.slice(start,start+FAV_PAGE_SIZE); var html='<div class="card" style="margin:.5rem 0"><h4>'+name+'</h4><div class="table">'; if(rows.length===0){ html+='<p class="small">No receivables yet.</p>'; } else { html+='<table><thead><tr><th>Date</th><th>Invoice #</th><th>Ledger</th><th>Amount</th><th>Comment</th></tr></thead><tbody>'; for(var r=0;r<rows.length;r++){ var it=rows[r]; html+='<tr><td>'+(it.date||'')+'</td><td>'+(it.invoiceNumber||'')+'</td><td>'+it.ledger+'</td><td>'+naira(it.amount)+'</td><td>'+(it.comment||'')+'</td></tr>'; } html+='</tbody></table>'; } var total=0; for(var q=0;q<allRows.length;q++){ total+=Number(allRows[q].amount||0); } html+='<div class="pill" style="margin-top:.5rem">Total: '+naira(total)+'</div>'; html+='<div class="row wrap" style="margin-top:.5rem"><span class="small">Page '+window.__favPages[name]+'/'+totalPages+'</span><div style="margin-left:auto; display:flex; gap:.5rem"><button class="outline" data-favprev="'+name+'" type="button">Prev</button><button class="outline" data-favnext="'+name+'" type="button">Next</button></div></div>'; html+='</div></div>'; var div=document.createElement('div'); div.innerHTML=html; box.appendChild(div); var prevBtn=div.querySelector('button[data-favprev="'+name+'"]'); var nextBtn=div.querySelector('button[data-favnext="'+name+'"]'); on(prevBtn,'click', function(){ if(window.__favPages[name]>1){ window.__favPages[name]--; refreshFavouriteSections(); } }); on(nextBtn,'click', function(){ if(window.__favPages[name]<totalPages){ window.__favPages[name]++; refreshFavouriteSections(); } }); })(favs[i]); } }catch(e){ consoleError(e); }
    }

    var editingId=null;
    function openEditModal(id){ try{ editingId=id; var modal=$('#edit-modal'); var ledgerSel=$('#edit-ledger'); if(!modal||!ledgerSel) return; ledgerSel.innerHTML=''; var ledgers=Store.getLedgers(); for(var i=0;i<ledgers.length;i++){ var o=document.createElement('option'); o.value=ledgers[i]; o.textContent=ledgers[i]; ledgerSel.appendChild(o);} var all=Store.listReceivables('All'); var it=null; for(var j=0;j<all.length;j++){ if(all[j].id===id){ it=all[j]; break; } } if(!it) return; var dEl=$('#edit-date'); if(dEl) dEl.value=it.date||new Date().toISOString().slice(0,10); var cEl=$('#edit-customer'); if(cEl) cEl.value=it.customer||''; var invEl=$('#edit-invnum'); if(invEl) invEl.value=it.invoiceNumber||''; var aEl=$('#edit-amount'); if(aEl) aEl.value=Number(it.amount||0); var comEl=$('#edit-comment'); if(comEl) comEl.value=it.comment||''; ledgerSel.value=it.ledger; if(modal.classList&&modal.classList.remove) modal.classList.remove('hidden'); else modal.style.display='block'; }catch(e){ consoleError(e); }
    }
    window.openEditModal=openEditModal;
    on($('#edit-cancel'),'click', function(){ var m=$('#edit-modal'); if(m){ if(m.classList&&m.classList.add) m.classList.add('hidden'); else m.style.display='none'; } editingId=null; });
    on($('#edit-save'),'click', function(){ try{ if(!editingId) return; var fields={ date:($('#edit-date')&&$('#edit-date').value)?$('#edit-date').value:new Date().toISOString().slice(0,10), customer:($('#edit-customer')?$('#edit-customer').value.trim():''), invoiceNumber:($('#edit-invnum')?$('#edit-invnum').value.trim():''), amount:Number(($('#edit-amount')?$('#edit-amount').value:0)||0), comment:($('#edit-comment')?$('#edit-comment').value.trim():''), ledger:($('#edit-ledger')?$('#edit-ledger').value:'') }; if(!fields.customer){ alert('Enter customer'); return;} Store.updateReceivable(editingId, fields); var m=$('#edit-modal'); if(m){ if(m.classList&&m.classList.add) m.classList.add('hidden'); else m.style.display='none'; } editingId=null; refreshReceivables(); refreshDashboard(); }catch(e){ consoleError(e); }});

    var productSelect=$('#stock-product');
    function populateProducts(){ try{ var products=Store.listProducts(); if(!productSelect) return; productSelect.innerHTML=''; for(var name in products){ if(products.hasOwnProperty(name)){ var price=products[name]; var opt=document.createElement('option'); opt.value=name; opt.textContent=name; opt.setAttribute('data-price', price); productSelect.appendChild(opt);} } syncPriceFromProduct(); }catch(e){ consoleError(e); }
    }
    function syncPriceFromProduct(){ var sel=(productSelect && productSelect.options[productSelect.selectedIndex])?productSelect.options[productSelect.selectedIndex]:null; var priceEl=$('#stock-price'); if(priceEl) priceEl.value = sel? sel.getAttribute('data-price') : 0; }
    on(productSelect,'change', syncPriceFromProduct);

    function refreshStockTable(){ try{ var sel=ledgerSelects.stock; var ledger=sel?sel.value:''; var items=ledger?Store.getStockForLedger(ledger):[]; var wrap=$('#stock-table'); if(!wrap) return; var html='<table><thead><tr><th>Product</th><th>Price (₦)</th><th>Qty</th><th>Value</th></tr></thead><tbody>'; for(var i=0;i<items.length;i++){ var it=items[i]; html+='<tr><td>'+it.name+'</td><td>'+naira(it.price)+'</td><td>'+it.qty+'</td><td>'+naira(it.value)+'</td></tr>'; } html+='</tbody></table>'; wrap.innerHTML=html; var total=0; for(var q=0;q<items.length;q++){ total+=items[q].value; } var totEl=$('#stock-total'); if(totEl) totEl.textContent='Total Value: '+naira(total); refreshDashboard(); }catch(e){ consoleError(e); }
    }
    on($('#add-stock-btn'),'click', function(){ try{ var ledger=(ledgerSelects.stock?ledgerSelects.stock.value:''); var product=(productSelect?productSelect.value:''); var priceEl=$('#stock-price'); var qtyEl=$('#stock-qty'); var price=Number(priceEl?priceEl.value:0); var qty=Number(qtyEl?qtyEl.value:0); if(!ledger){ alert('Select a ledger'); return;} if(!product){ alert('Select a product'); return;} Store.setStock(ledger,product,price,qty); if(qtyEl) qtyEl.value=''; refreshStockTable(); }catch(e){ consoleError(e); }});

    function refreshDashboard(){ try{ var sel=ledgerSelects.dashboard; var ledger=(sel&&sel.value)?sel.value:((Store.getLedgers()[0])||''); var t=Store.paymentsTotals(ledger); var credits=t.credits, debits=t.debits; var recv=Store.receivablesTotal(ledger); var stock=Store.stockTotalValue(ledger); var profit=(credits+recv+stock)-debits; var elD=$('#stat-debits'), elC=$('#stat-credits'), elR=$('#stat-recv'), elS=$('#stat-stock'); if(elD) elD.textContent=naira(debits); if(elC) elC.textContent=naira(credits); if(elR) elR.textContent=naira(recv); if(elS) elS.textContent=naira(stock); var w=$('#business-worth'); if(w){ w.textContent=naira(profit); w.style.color='#ffffff'; if(profit>0){ w.style.background='#065f46'; } else if(profit<0){ w.style.background='#7f1d1d'; } else { w.style.background='#6b7280'; } } }catch(e){ consoleError(e); }
    }
    on(ledgerSelects.dashboard,'change', refreshDashboard); on(ledgerSelects.stock,'change', refreshStockTable);

    function download(name, text, type){ var blob=new Blob([text],{type:type}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    var exportBackupBtn=$('#btn-export-backup'); var importBackupBtn=$('#btn-import-backup'); var exportAllCsvBtn=$('#btn-export-all-csv'); var importAllCsvBtn=$('#btn-import-all-csv'); var fileBackup=$('#file-import-backup'); var fileCsv=$('#file-import-csv');
    on(exportBackupBtn,'click', function(){ try{ var payload={ version:'v13', exportedAt:new Date().toISOString(), data:Store.exportState() }; download('ledger_backup.json', JSON.stringify(payload,null,2), 'application/json'); }catch(e){ consoleError(e); }});
    on(importBackupBtn,'click', function(){ try{ if(fileBackup) fileBackup.click(); }catch(e){ consoleError(e); }});
    on(fileBackup,'change', function(){ try{ var f=(fileBackup&&fileBackup.files&&fileBackup.files[0])?fileBackup.files[0]:null; if(!f) return; var reader=new FileReader(); reader.onload=function(){ try{ var obj=JSON.parse(String(reader.result||'{}')); var data=(obj&&obj.data)?obj.data:obj; var res=Store.importState(data); if(!res.ok){ alert(res.msg||'Import failed'); return;} alert('Backup restored successfully'); location.reload(); }catch(e){ alert('Invalid JSON'); } }; reader.readAsText(f); fileBackup.value=''; }catch(e){ consoleError(e); }});

    on(exportAllCsvBtn,'click', function(){ try{ var header=['type','id','createdAt','ledger','date','amount','paymentType','name','invoiceType','invoiceNumber','customer','comment','stockProduct','stockPrice','stockQty']; var lines=[header.join(',')]; var pays=Store.listPayments('All'); for(var i=0;i<pays.length;i++){ var p=pays[i]; if(p.type==='credit') lines.push(['payment_credit', p.id||'', p.createdAt||'', p.ledger, p.date||'', p.amount||'', p.paymentType||'', p.name||'', '', '', '', '', '', '', ''].map(escCSV).join(',')); else lines.push(['payment_debit', p.id||'', p.createdAt||'', p.ledger, p.date||'', p.amount||'', '', '', p.invoiceType||'', p.invoiceNumber||'', '', '', '', '', ''].map(escCSV).join(',')); }
      var recs=Store.listReceivables('All'); for(var j=0;j<recs.length;j++){ var r=recs[j]; lines.push(['receivable', r.id||'', r.createdAt||'', r.ledger, r.date||'', r.amount||'', '', '', '', r.invoiceNumber||'', r.customer||'', r.comment||'', '', '', ''].map(escCSV).join(',')); }
      var ledgers=Store.getLedgers(); for(var l=0;l<ledgers.length;l++){ var ldg=ledgers[l]; var items=Store.getStockForLedger(ldg); for(var s=0;s<items.length;s++){ var it=items[s]; lines.push(['stock', '', '', ldg, '', '', '', '', '', '', '', '', it.name||'', it.price||0, it.qty||0].map(escCSV).join(',')); } }
      download('ledger_all.csv', lines.join('
'), 'text/csv;charset=utf-8;'); }catch(e){ consoleError(e); }});

    on(importAllCsvBtn,'click', function(){ try{ if(fileCsv) fileCsv.click(); }catch(e){ consoleError(e); }});
    on(fileCsv,'change', function(){ try{ var f=(fileCsv&&fileCsv.files&&fileCsv.files[0])?fileCsv.files[0]:null; if(!f) return; var reader=new FileReader(); reader.onload=function(){ try{ var txt=String(reader.result||''); var rows=txt.split(/?
/).filter(function(x){return x.trim().length>0;}); if(rows.length<2){ alert('CSV is empty'); return; } var header=rows[0].split(','); function trimq(s){ return s.replace(/^"|"$/g,'').trim(); } for(var h=0;h<header.length;h++){ header[h]=trimq(header[h]); }
          function idx(name){ for(var i=0;i<header.length;i++){ if(header[i]===name) return i; } return -1; }
          var I={ type:idx('type'), id:idx('id'), createdAt:idx('createdAt'), ledger:idx('ledger'), date:idx('date'), amount:idx('amount'), paymentType:idx('paymentType'), name:idx('name'), invoiceType:idx('invoiceType'), invoiceNumber:idx('invoiceNumber'), customer:idx('customer'), comment:idx('comment'), stockProduct:idx('stockProduct'), stockPrice:idx('stockPrice'), stockQty:idx('stockQty') };
          function unq(s){ return String(s||'').replace(/^"|"$/g,'').replace(/""/g,'"'); }
          function toCells(line){ var out=[], cur='', q=false; for(var i=0;i<line.length;i++){ var ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } } else if(ch===',' && !q){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out; }
          var neededLedgers={}; for(var r=1;r<rows.length;r++){ var cells=toCells(rows[r]); var led=unq(cells[I.ledger]); if(led) neededLedgers[led]=true; }
          var currentLedgers=Store.getLedgers(); for(var led in neededLedgers){ var found=false; for(var i2=0;i2<currentLedgers.length;i2++){ if(currentLedgers[i2]===led){ found=true; break; } } if(!found){ Store.addLedger(led); } }
          Store.clearTransactionsAndStock();
          for(var r2=1;r2<rows.length;r2++){
            var cells=toCells(rows[r2]); if(cells.length===1 && cells[0].trim()==='') continue; var t=cells[I.type]?unq(cells[I.type]):'';
            if(t==='payment_credit'){ Store.addCredit({ date:unq(cells[I.date]), name:unq(cells[I.name]), paymentType:unq(cells[I.paymentType]), amount:Number(unq(cells[I.amount])||0), ledger:unq(cells[I.ledger]) }); }
            else if(t==='payment_debit'){ Store.addDebit({ date:unq(cells[I.date]), invoiceType:unq(cells[I.invoiceType]), invoiceNumber:unq(cells[I.invoiceNumber]), amount:Number(unq(cells[I.amount])||0), ledger:unq(cells[I.ledger]) }); }
            else if(t==='receivable'){ Store.addReceivable({ date:unq(cells[I.date]), customer:unq(cells[I.customer]), invoiceNumber:unq(cells[I.invoiceNumber]), amount:Number(unq(cells[I.amount])||0), comment:unq(cells[I.comment]), ledger:unq(cells[I.ledger]) }); }
            else if(t==='stock'){ var ldg=unq(cells[I.ledger]); var prod=unq(cells[I.stockProduct]); var price=Number(unq(cells[I.stockPrice])||0); var qty=Number(unq(cells[I.stockQty])||0); if(ldg && prod){ Store.setStock(ldg, prod, price, qty); } }
          }
          alert('CSV imported successfully'); location.reload();
        } catch(e){ consoleError(e); alert('CSV parse error'); }
      };
      reader.readAsText(f);
      fileCsv.value='';
    }catch(e){ consoleError(e); }});

    try{ populateProducts(); refreshLedgers(); if(ledgerSelects.payment && ledgerSelects.payment.options.length>0) ledgerSelects.payment.selectedIndex=0; if(ledgerSelects.paymentsFilter && ledgerSelects.paymentsFilter.options.length>0) ledgerSelects.paymentsFilter.selectedIndex=0; if(ledgerSelects.recv && ledgerSelects.recv.options.length>0) ledgerSelects.recv.selectedIndex=0; if(ledgerSelects.recvFilter && ledgerSelects.recvFilter.options.length>0) ledgerSelects.recvFilter.selectedIndex=0; if(ledgerSelects.stock && ledgerSelects.stock.options.length>0) ledgerSelects.stock.selectedIndex=0; if(ledgerSelects.dashboard && ledgerSelects.dashboard.options.length>0) ledgerSelects.dashboard.selectedIndex=0; refreshPaymentsTable(); refreshStockTable(); refreshDashboard(); }catch(e){ consoleError(e); }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();